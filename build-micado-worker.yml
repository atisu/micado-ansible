---
- name: Build MiCADO worker
  hosts: workers
  gather_facts: False

  pre_tasks:
    - name: (System) Ensure that python3 installed
      raw: bash -c "test -e /usr/bin/python3" || (apt -qqy update && apt install -qqy python3-minimal)
      register: output
      changed_when: not output.stdout

    - name: (System) Turn back gather_fact
      setup:

    - name: (System) Check requirements
      assert:
        that:
          "{{ item.that }}"
        msg: >
          "{{ item.msg }}"
      loop:
        - that: |
            ansible_os_family == 'Debian' and ansible_distribution_version == '16.04'
            or ansible_distribution_version == '18.04' or ansible_distribution_version == '20.04'
          msg: 'The required OS is Ubuntu, supported versions are 16.04, 18.04 or 20.04'
        - { that: "ansible_memtotal_mb >= 1950", msg: 'The minimum required memory size is 2 GB' }
        - { that: "ansible_mounts | selectattr('mount','equalto', '/') | map(attribute='size_total') | list | first >= 7000000000",
            msg: 'The minimum required disk size is 8 GB' }

    - name: (System) Waiting for automatic security updates to finish
      script: pre-task/wait-updates.sh
      register: outputsh
      changed_when: not outputsh.stdout

  roles:
    - micado_worker/build